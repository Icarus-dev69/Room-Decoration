<html>
  <head>
    <meta charset="utf-8" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      .model-thumb {
        height: 80px;
        margin: 5px;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 8px;
      }
      .model-thumb.selected {
        border-color: #0077ff;
      }
    </style>
  </head>

  <body style="margin: 0; overflow: hidden">
    <button id="toggle-mode" style="position: absolute; top: 10px; left: 10px; z-index: 9999;">
    Mode: MOVE
</button>
<button id="place-btn" style="
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  background-color: #2196F3;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  z-index: 10;
  display: none;
">Place Object</button>
<button id="take-picture-btn" style="
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  padding: 12px 20px;
  background-color: #4CAF50;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  z-index: 10;
">Take Picture</button>

<div id="countdown-overlay" style="
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 48px;
  color: white;
  font-weight: bold;
  text-align: center;
  z-index: 20;
  display: none;
  text-shadow: 2px 2px 8px black;
">
  Please stay still<br><span id="countdown-number">3</span>
</div>
    <a-scene
      embedded
      arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
      renderer="logarithmicDepthBuffer: true;"
      vr-mode-ui="enabled: false"
    >
      <!-- <a-box position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
      <a-plane position="0 0 -4" rotation="-90 0 0" width="4" height="4" color="#7BC8A4"></a-plane> -->
      <!-- <a-sky color="#ECECEC"></a-sky> -->
      <!-- Camera -->
      <a-entity id="camera" camera position="0 1.6 0"></a-entity>

      <!-- Add this inside your <a-scene> -->
      <a-entity id="raycaster" raycaster="objects: #ground"></a-entity>


      <!-- Invisible ground to receive touch interactions -->
      <a-plane
        id="ground"
        rotation="-90 0 0"
        width="10"
        height="10"
        visible="false"
      ></a-plane>

      <!-- Your model -->
       <!-- <a-assets>
          <a-asset-item id="testmodel" src="./assets/models/test.glb"></a-asset-item>
        </a-assets> -->

        <!-- <a-entity gltf-model="#testmodel" scale="0.05 0.05 0.05"></a-entity> -->

    </a-scene>
    <div id="model-selector" style="position: absolute; bottom: 10px; left: 0; right: 0; display: flex; overflow-x: auto; z-index: 9999;">
      <img src="assets/thumbnails/test1.png" data-model="assets/models/test.glb" class="model-thumb" />
      <img src="assets/thumbnails/test2.png" data-model="assets/models/test2.glb" class="model-thumb" />
      <!-- Add more models as needed -->
    </div>
    
    
    

    <script>
      const toggleBtn = document.getElementById("toggle-mode");

      // Mode cycling
      const modes = ["move","scale", "rotateX", "rotateY"];
      let currentModeIndex = 0;
      let mode = modes[currentModeIndex];
      toggleBtn.innerText = `Mode: ${mode.replace("-", " ").toUpperCase()}`;

      toggleBtn.addEventListener("click", () => {
        currentModeIndex = (currentModeIndex + 1) % modes.length;
        mode = modes[currentModeIndex];
        toggleBtn.innerText = `Mode: ${mode.replace("-", " ").toUpperCase()}`;
      });

      let activeFurniture = null;
      let scene = document.querySelector("a-scene");
      const cameraEl = document.querySelector("[camera]");
      const placeBtn = document.getElementById("place-btn");

      // Touch interaction
      let touchStartX = 0;
      let touchStartY = 0;
      let initialPos = null;
      let initialRot = null;

      let initialDistance = null;
      let initialScale = null;
      let newFurniture = null;

      // Model selection
      document.querySelectorAll(".model-thumb").forEach((img) => {
        img.addEventListener("click", () => {
          document.querySelectorAll(".model-thumb").forEach((i) => i.classList.remove("selected"));
          img.classList.add("selected");

          const modelUrl = img.getAttribute("data-model");
          newFurniture = document.createElement("a-entity");
          newFurniture.setAttribute("gltf-model", modelUrl);
          newFurniture.setAttribute("scale", "0.1 0.1 0.1");
          // newFurniture.setAttribute("position", "0 0 -4");
          newFurniture.setAttribute("auto-bounds", "");
          newFurniture.classList.add("furniture-item");

          scene.appendChild(newFurniture);
          // cameraEl.appendChild(newFurniture); // attach to camera so it follows
          // placeBtn.style.display = "block"; // show the "Place" button
          setActiveFurniture(newFurniture);
        });
      });
      placeBtn.addEventListener("click", () => {
        if (!newFurniture || !cameraEl.contains(newFurniture)) return;

        // Step 1: Get world position before detaching
        const worldPos = new THREE.Vector3();
        newFurniture.object3D.getWorldPosition(worldPos);

        console.log(newFurniture.object3D)

        // Step 2: Detach and reattach to scene
        cameraEl.removeChild(newFurniture);
        scene.appendChild(newFurniture);

        // Step 3: Set position in world space
        newFurniture.setAttribute("position", {
          x: worldPos.x,
          y: worldPos.y,
          z: worldPos.z
        });

        // Step 4: Optional - reset rotation if needed
        // newFurniture.setAttribute("rotation", "0 0 0");

        setActiveFurniture(newFurniture);
        newFurniture = null;
        placeBtn.style.display = "none";
      });

      // Tap to select placed model
      scene.addEventListener("click", (e) => {
        const target = e.target;
        if (target.classList.contains("furniture-item")) {
          setActiveFurniture(target);
        }
      });

      function setActiveFurniture(el) {
        activeFurniture = el;
      }

      // Touch start
      scene.addEventListener("touchstart", (e) => {
        if (!activeFurniture) return;

        if (e.touches.length === 1) {
          const touch = e.touches[0];
          touchStartX = touch.clientX;
          touchStartY = touch.clientY;
          initialPos = Object.assign({}, activeFurniture.getAttribute("position"));
          initialRot = Object.assign({}, activeFurniture.getAttribute("rotation"));
        }

        if (e.touches.length === 2 && mode === "scale") {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          initialDistance = Math.sqrt(dx * dx + dy * dy);
          initialScale = Object.assign({}, activeFurniture.getAttribute("scale"));
        }
      });

      // Touch move
      scene.addEventListener("touchmove", (e) => {
        if (!activeFurniture) return;
        e.preventDefault();

        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const dx = touch.clientX - touchStartX;
          const dy = touch.clientY - touchStartY;

          if (mode === "move") {
          const scaleFactor = 0.01;
          const newX = initialPos.x + dx * scaleFactor;
          const newY = initialPos.y + dy * -scaleFactor; // negative to match screen direction
          activeFurniture.setAttribute("position", { x: newX, y: newY, z: initialPos.z });
        } else if (mode === "rotateY") {
            const newRotX = initialRot.x + dy * 0.5;
            activeFurniture.setAttribute("rotation", {
              x: newRotX,
              y: initialRot.y,
              z: initialRot.z,
            });
          } else if (mode === "rotateX") {
            const newRotY = initialRot.y + dx * 0.5;
            activeFurniture.setAttribute("rotation", {
              x: initialRot.x,
              y: newRotY,
              z: initialRot.z,
            });
          }
        }

        if (e.touches.length === 2 && mode === "scale" && initialDistance) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const currentDistance = Math.sqrt(dx * dx + dy * dy);
          const scaleFactor = currentDistance / initialDistance;

          const newScale = {
            x: initialScale.x * scaleFactor,
            y: initialScale.y * scaleFactor,
            z: initialScale.z * scaleFactor,
          };

          const minScale = 0.001;
          const maxScale = 5;

          newScale.x = Math.min(maxScale, Math.max(minScale, newScale.x));
          newScale.y = Math.min(maxScale, Math.max(minScale, newScale.y));
          newScale.z = Math.min(maxScale, Math.max(minScale, newScale.z));

          activeFurniture.setAttribute("scale", newScale);
        }
      });

      const takePictureBtn = document.getElementById("take-picture-btn");
      const countdownOverlay = document.getElementById("countdown-overlay");
      const countdownNumber = document.getElementById("countdown-number");

      takePictureBtn.addEventListener("click", () => {
        countdownOverlay.style.display = "block";
        let counter = 3;
        countdownNumber.innerText = counter;

        const countdownInterval = setInterval(() => {
          counter--;
          if (counter > 0) {
            countdownNumber.innerText = counter;
          } else {
            clearInterval(countdownInterval);
            countdownOverlay.style.display = "none";

            // Take screenshot
            scene.components.screenshot.capture('perspective')
              .then(dataUrl => {
                // Create a download link
                const link = document.createElement('a');
                link.href = dataUrl;
                link.download = 'AR_Snapshot.png';
                link.click();
              })
              .catch(err => console.error("Screenshot failed:", err));
          }
        }, 1000);
      });
    </script>

  </body>
</html>
